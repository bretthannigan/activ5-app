{"version":3,"file":"activ5-device.js.map","sources":["ng://activ5-device/a5-device-manager.ts"],"sourcesContent":["/// <reference path=\"index.d.ts\" />\r\n\r\nimport { Observable, Subject } from 'rxjs';\r\n\r\nenum DeviceUUID {\r\n  SERVICE = '00005000-0000-1000-8000-00805f9b34fb',\r\n  READ = '00005a01-0000-1000-8000-00805f9b34fb',\r\n  WRITE = '00005a02-0000-1000-8000-00805f9b34fb'\r\n}\r\n\r\nenum DeviceCommands {\r\n  TVGTIME = 'TVGTIME',\r\n  ISOM = 'ISOM!',\r\n  TARE = 'TARE!',\r\n  STOP = 'STOP!'\r\n}\r\n\r\nenum DeviceState {\r\n  handshake = 'handshake',\r\n  isometric = 'isometric',\r\n  stop = 'stop',\r\n  disconnected = 'disconnected'\r\n}\r\n\r\nexport class A5DeviceManager {\r\n\r\n  public async connect(): Promise<A5Device> {\r\n    if (window.navigator && window.navigator.bluetooth) {\r\n      const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [DeviceUUID.SERVICE] }] });\r\n      const server = await device.gatt.connect();\r\n      const service = await server.getPrimaryService(DeviceUUID.SERVICE);\r\n\r\n      return new A5Device(device, server, service);\r\n    }\r\n  }\r\n\r\n}\r\n\r\nexport class A5Device {\r\n\r\n  constructor(device: BluetoothDevice, server: BluetoothRemoteGATTServer, service: BluetoothRemoteGATTService) {\r\n    this.device = device;\r\n    this.server = server;\r\n    this.service = service;\r\n\r\n    this.init();\r\n  }\r\n\r\n  public device: BluetoothDevice;\r\n  private server: BluetoothRemoteGATTServer;\r\n  private service: BluetoothRemoteGATTService;\r\n\r\n  private disconnectEventAsObservable = new Subject<Event>();\r\n  private isomDataAsObservable = new Subject<string>();\r\n\r\n  private evergreenModeTimer: number;\r\n  private characteristics = new Map();\r\n  private deviceState = DeviceState.disconnected;\r\n\r\n  public getIsometricData(): Observable<string> {\r\n    return this.isomDataAsObservable.asObservable();\r\n  }\r\n\r\n  public onDisconnect(): Observable<Event> {\r\n    return this.disconnectEventAsObservable.asObservable();\r\n  }\r\n\r\n  public async startIsometric(): Promise<void> {\r\n    await this.writeCharacteristicValue(this.formatCommand(DeviceCommands.ISOM));\r\n    this.deviceState = DeviceState.isometric;\r\n\r\n    const characteristic = await this.startNotifications();\r\n    this.attachIsometricListener(characteristic);\r\n  }\r\n\r\n  public tare(): void {\r\n    this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TARE));\r\n  }\r\n\r\n  public async stop(): Promise<void> {\r\n    await this.writeCharacteristicValue(this.formatCommand(DeviceCommands.STOP));\r\n    this.deviceState = DeviceState.stop;\r\n  }\r\n\r\n  public evergreenMode(isEvergreenMode: boolean): void {\r\n    if (isEvergreenMode) {\r\n      this.evergreenModeTimer = window.setInterval(() => {\r\n        switch (this.deviceState) {\r\n          case DeviceState.stop:\r\n          case DeviceState.handshake:\r\n            this.stop();\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n      }, 60000);\r\n    } else {\r\n      clearInterval(this.evergreenModeTimer);\r\n    }\r\n  }\r\n\r\n  public disconnect(): void {\r\n    this.device.gatt.disconnect();\r\n  }\r\n\r\n  private async init(): Promise<void> {\r\n    await this.cacheCharacteristic(DeviceUUID.READ);\r\n    await this.cacheCharacteristic(DeviceUUID.WRITE);\r\n\r\n    await this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TVGTIME));\r\n\r\n\r\n    this.deviceState = DeviceState.handshake;\r\n    this.attachDisconnectListener();\r\n  }\r\n\r\n  private attachDisconnectListener(): void {\r\n    this.device.addEventListener('gattserverdisconnected', (event: Event) => {\r\n      this.disconnectEventAsObservable.next(event);\r\n      this.deviceState = DeviceState.disconnected;\r\n      this.device = undefined;\r\n      this.server = undefined;\r\n      this.service = undefined;\r\n    });\r\n  }\r\n\r\n  private async cacheCharacteristic(characteristicUuid: string): Promise<void> {\r\n    const characteristic = await this.service.getCharacteristic(characteristicUuid);\r\n    this.characteristics.set(characteristicUuid, characteristic);\r\n  }\r\n\r\n  private writeCharacteristicValue(value: DataView): Promise<void> {\r\n    const characteristic = this.characteristics.get(DeviceUUID.WRITE);\r\n    return characteristic.writeValue(value);\r\n  }\r\n\r\n  private startNotifications(): Promise<BluetoothRemoteGATTCharacteristic> {\r\n    const characteristic = this.characteristics.get(DeviceUUID.READ);\r\n    return characteristic.startNotifications();\r\n  }\r\n\r\n  private attachIsometricListener(characteristic: BluetoothRemoteGATTCharacteristic): void {\r\n    characteristic.addEventListener('characteristicvaluechanged', event => {\r\n      const target = event.target as BluetoothRemoteGATTCharacteristic;\r\n      this.parseData(target.value);\r\n    });\r\n  }\r\n\r\n  private parseData(data: DataView): void {\r\n    const deviceDataAsString = String.fromCharCode.apply(null, new Uint8Array(data.buffer));\r\n    const isomData = deviceDataAsString.match(/IS(.*)\\/IS/)[1];\r\n\r\n    this.isomDataAsObservable.next(isomData);\r\n  }\r\n\r\n  private formatCommand(type: string): DataView {\r\n    const buffer = new ArrayBuffer(type.length + 2);\r\n    const dataView = new DataView(buffer, 0);\r\n\r\n    dataView.setUint8(0, 65);\r\n\r\n    for (let i = 0; i < type.length; i++) {\r\n        dataView.setUint8(i + 1, type.charCodeAt(i));\r\n    }\r\n\r\n    dataView.setUint8(type.length + 1, 25);\r\n\r\n    return dataView;\r\n  }\r\n\r\n}\r\n"],"names":[],"mappings":"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"}
