/*! *****************************************************************************
    Copyright (c) Activbody Inc. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */

import*as tslib_1 from"tslib";import{Subject}from"rxjs";var DeviceUUID={SERVICE:"00005000-0000-1000-8000-00805f9b34fb",READ:"00005a01-0000-1000-8000-00805f9b34fb",WRITE:"00005a02-0000-1000-8000-00805f9b34fb"},DeviceCommands={TVGTIME:"TVGTIME",ISOM:"ISOM!",TARE:"TARE!",STOP:"STOP!"},DeviceState={handshake:"handshake",isometric:"isometric",stop:"stop",disconnected:"disconnected"},A5DeviceManager=function(){function t(){}return t.prototype.connect=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,e,i;return tslib_1.__generator(this,function(r){switch(r.label){case 0:return window.navigator&&window.navigator.bluetooth?[4,navigator.bluetooth.requestDevice({filters:[{services:[DeviceUUID.SERVICE]}]})]:[3,4];case 1:return[4,(t=r.sent()).gatt.connect()];case 2:return[4,(e=r.sent()).getPrimaryService(DeviceUUID.SERVICE)];case 3:return i=r.sent(),[2,new A5Device(t,e,i)];case 4:return[2]}})})},t}();export{A5DeviceManager};var A5Device=function(){function t(t,e,i){this.disconnectEventAsObservable=new Subject,this.isomDataAsObservable=new Subject,this.characteristics=new Map,this.deviceState=DeviceState.disconnected,this.device=t,this.server=e,this.service=i,this.init()}return t.prototype.getIsometricData=function(){return this.isomDataAsObservable.asObservable()},t.prototype.onDisconnect=function(){return this.disconnectEventAsObservable.asObservable()},t.prototype.startIsometric=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var t;return tslib_1.__generator(this,function(e){switch(e.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(DeviceCommands.ISOM))];case 1:return e.sent(),this.deviceState=DeviceState.isometric,[4,this.startNotifications()];case 2:return t=e.sent(),this.attachIsometricListener(t),[2]}})})},t.prototype.tare=function(){this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TARE))},t.prototype.stop=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){switch(t.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(DeviceCommands.STOP))];case 1:return t.sent(),this.deviceState=DeviceState.stop,[2]}})})},t.prototype.evergreenMode=function(t){var e=this;t?this.evergreenModeTimer=window.setInterval(function(){switch(e.deviceState){case DeviceState.stop:case DeviceState.handshake:e.stop()}},6e4):clearInterval(this.evergreenModeTimer)},t.prototype.disconnect=function(){this.device.gatt.disconnect()},t.prototype.init=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){switch(t.label){case 0:return[4,this.cacheCharacteristic(DeviceUUID.READ)];case 1:return t.sent(),[4,this.cacheCharacteristic(DeviceUUID.WRITE)];case 2:return t.sent(),[4,this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TVGTIME))];case 3:return t.sent(),this.deviceState=DeviceState.handshake,this.attachDisconnectListener(),[2]}})})},t.prototype.attachDisconnectListener=function(){var t=this;this.device.addEventListener("gattserverdisconnected",function(e){t.disconnectEventAsObservable.next(e),t.deviceState=DeviceState.disconnected,t.device=void 0,t.server=void 0,t.service=void 0})},t.prototype.cacheCharacteristic=function(t){return tslib_1.__awaiter(this,void 0,void 0,function(){var e;return tslib_1.__generator(this,function(i){switch(i.label){case 0:return[4,this.service.getCharacteristic(t)];case 1:return e=i.sent(),this.characteristics.set(t,e),[2]}})})},t.prototype.writeCharacteristicValue=function(t){return this.characteristics.get(DeviceUUID.WRITE).writeValue(t)},t.prototype.startNotifications=function(){return this.characteristics.get(DeviceUUID.READ).startNotifications()},t.prototype.attachIsometricListener=function(t){var e=this;t.addEventListener("characteristicvaluechanged",function(t){var i=t.target;e.parseData(i.value)})},t.prototype.parseData=function(t){var e=String.fromCharCode.apply(null,new Uint8Array(t.buffer)).match(/IS(.*)\/IS/)[1];this.isomDataAsObservable.next(e)},t.prototype.formatCommand=function(t){var e=new ArrayBuffer(t.length+2),i=new DataView(e,0);i.setUint8(0,65);for(var r=0;r<t.length;r++)i.setUint8(r+1,t.charCodeAt(r));return i.setUint8(t.length+1,25),i},t}();export{A5Device};