/*! *****************************************************************************
    Copyright (c) Activbody Inc. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */

import{__awaiter,__generator}from"tslib";import{Subject}from"rxjs";var DeviceUUID={SERVICE:"00005000-0000-1000-8000-00805f9b34fb",READ:"00005a01-0000-1000-8000-00805f9b34fb",WRITE:"00005a02-0000-1000-8000-00805f9b34fb"},DeviceCommands={TVGTIME:"TVGTIME",ISOM:"ISOM!",TARE:"TARE!",STOP:"STOP!"},DeviceState={handshake:"handshake",isometric:"isometric",stop:"stop",disconnected:"disconnected"},A5DeviceManager=function(){function e(){}return e.prototype.connect=function(){return __awaiter(this,void 0,void 0,function(){var e,t,i;return __generator(this,function(r){switch(r.label){case 0:return window.navigator&&window.navigator.bluetooth?[4,navigator.bluetooth.requestDevice({filters:[{services:[DeviceUUID.SERVICE]}]})]:[3,4];case 1:return[4,(e=r.sent()).gatt.connect()];case 2:return[4,(t=r.sent()).getPrimaryService(DeviceUUID.SERVICE)];case 3:return i=r.sent(),[2,new A5Device(e,t,i)];case 4:return[2]}})})},e}(),A5Device=function(){function e(e,t,i){this.disconnectEventAsObservable=new Subject,this.isomDataAsObservable=new Subject,this.characteristics=new Map,this.deviceState=DeviceState.disconnected,this.device=e,this.server=t,this.service=i,this.init()}return e.prototype.getIsometricData=function(){return this.isomDataAsObservable.asObservable()},e.prototype.onDisconnect=function(){return this.disconnectEventAsObservable.asObservable()},e.prototype.startIsometric=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(DeviceCommands.ISOM))];case 1:return t.sent(),this.deviceState=DeviceState.isometric,[4,this.startNotifications()];case 2:return e=t.sent(),this.attachIsometricListener(e),[2]}})})},e.prototype.tare=function(){this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TARE))},e.prototype.stop=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.writeCharacteristicValue(this.formatCommand(DeviceCommands.STOP))];case 1:return e.sent(),this.deviceState=DeviceState.stop,[2]}})})},e.prototype.evergreenMode=function(e){var t=this;e?this.evergreenModeTimer=window.setInterval(function(){switch(t.deviceState){case DeviceState.stop:case DeviceState.handshake:t.stop()}},6e4):clearInterval(this.evergreenModeTimer)},e.prototype.disconnect=function(){this.device.gatt.disconnect()},e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.cacheCharacteristic(DeviceUUID.READ)];case 1:return e.sent(),[4,this.cacheCharacteristic(DeviceUUID.WRITE)];case 2:return e.sent(),[4,this.writeCharacteristicValue(this.formatCommand(DeviceCommands.TVGTIME))];case 3:return e.sent(),this.deviceState=DeviceState.handshake,this.attachDisconnectListener(),[2]}})})},e.prototype.attachDisconnectListener=function(){var e=this;this.device.addEventListener("gattserverdisconnected",function(t){e.disconnectEventAsObservable.next(t),e.deviceState=DeviceState.disconnected,e.device=void 0,e.server=void 0,e.service=void 0})},e.prototype.cacheCharacteristic=function(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(i){switch(i.label){case 0:return[4,this.service.getCharacteristic(e)];case 1:return t=i.sent(),this.characteristics.set(e,t),[2]}})})},e.prototype.writeCharacteristicValue=function(e){return this.characteristics.get(DeviceUUID.WRITE).writeValue(e)},e.prototype.startNotifications=function(){return this.characteristics.get(DeviceUUID.READ).startNotifications()},e.prototype.attachIsometricListener=function(e){var t=this;e.addEventListener("characteristicvaluechanged",function(e){var i=e.target;t.parseData(i.value)})},e.prototype.parseData=function(e){var t=String.fromCharCode.apply(null,new Uint8Array(e.buffer)).match(/IS(.*)\/IS/)[1];this.isomDataAsObservable.next(t)},e.prototype.formatCommand=function(e){var t=new ArrayBuffer(e.length+2),i=new DataView(t,0);i.setUint8(0,65);for(var r=0;r<e.length;r++)i.setUint8(r+1,e.charCodeAt(r));return i.setUint8(e.length+1,25),i},e}();export{A5DeviceManager,A5Device};